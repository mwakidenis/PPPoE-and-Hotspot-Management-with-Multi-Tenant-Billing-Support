/**
 * DEPRECATED: This file is replaced by @/lib/timezone.ts
 * All dates in database are stored as UTC
 * Use timezone.ts for proper UTC â†” WIB conversion
 */

import { toWIB as _toWIB, formatWIB, daysUntilExpiry, relativeWIB, nowWIB as _nowWIB } from '@/lib/timezone'

const WIB_TIMEZONE = 'Asia/Jakarta'

/**
 * Parse date from database (UTC) and convert to WIB for display
 * Database stores UTC, we convert to WIB timezone
 */
function toWIB(dateStr: string | Date): Date | null {
  return _toWIB(dateStr)
}

/**
 * Format datetime string (UTC from DB) to WIB display
 */
export function formatToWIB(dateStr: string | Date): string {
  if (!dateStr) return '-'
  
  try {
    const wibDate = toWIB(dateStr)
    return format(wibDate, 'dd/MM/yyyy HH:mm:ss', { locale: id })
  } catch {
    return 'Invalid Date'
  }
}

export function formatDateOnly(dateStr: string | Date): string {
  if (!dateStr) return '-'
  
  try {
    const wibDate = toWIB(dateStr)
    return format(wibDate, 'dd/MM/yyyy', { locale: id })
  } catch {
    return 'Invalid Date'
  }
}

export function formatTimeOnly(dateStr: string | Date): string {
  if (!dateStr) return '-'
  
  try {
    const wibDate = toWIB(dateStr)
    return format(wibDate, 'HH:mm:ss', { locale: id })
  } catch {
    return 'Invalid Date'
  }
}

export function calculateTimeLeft(expiresAtStr: string | Date): string {
  if (!expiresAtStr) return '-'
  
  try {
    // Parse expires time from DB (UTC) and convert to WIB
    const expiresWIB = toWIB(expiresAtStr)
    
    // Get current time in WIB
    const nowWIB = toZonedTime(new Date(), WIB_TIMEZONE)
    
    const diff = Math.max(0, Math.floor((expiresWIB.getTime() - nowWIB.getTime()) / 1000))
    
    const hours = Math.floor(diff / 3600)
    const minutes = Math.floor((diff % 3600) / 60)
    const seconds = diff % 60
    
    if (hours > 0) return `${hours}h ${minutes}m left`
    if (minutes > 0) return `${minutes}m ${seconds}s left`
    return `${seconds}s left`
  } catch {
    return 'Invalid'
  }
}

/**
 * Get current time in WIB
 */
export function nowInWIB(): Date {
  return toZonedTime(new Date(), WIB_TIMEZONE)
}

/**
 * Format relative time (e.g., "2 hours ago")
 */
export function formatRelativeTime(dateStr: string | Date): string {
  if (!dateStr) return '-'
  
  try {
    const wibDate = toWIB(dateStr)
    const nowWIB = toZonedTime(new Date(), WIB_TIMEZONE)
    
    const diffSeconds = Math.floor((nowWIB.getTime() - wibDate.getTime()) / 1000)
    
    if (diffSeconds < 60) return 'Just now'
    if (diffSeconds < 3600) return `${Math.floor(diffSeconds / 60)} minutes ago`
    if (diffSeconds < 86400) return `${Math.floor(diffSeconds / 3600)} hours ago`
    return `${Math.floor(diffSeconds / 86400)} days ago`
  } catch {
    return 'Invalid'
  }
}
